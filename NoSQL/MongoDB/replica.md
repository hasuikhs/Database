# Replica

## 3. 애플리케이션에서 복제 셋 연결

### 3.1 클라이언트-복제 셋 연결 동작
- 몽고DB 클라이언트(드라이버)는 서버가 독립 실행형 몽고 DB 인스턴스든 보제 셋이든 관계없이 서버와의 통신을 관리하도록 설계
  - 복제 셋이면 기본적으로 클라이언트는 프라이머리에 연결되고 모든 트래픽을 프라이머리에 라우팅
  - 애플리케이션은 복제 셋이 조용히 백그라운드에서 대기 상태를 유지하는 동안 마치 독립 실행형 서버와 통신하듯이 읽기와 쓰기 수행 가능
- 복제 셋에 대한 연결은 단일 서버에 대한 연결과 비슷
  - 드라이버에서 MongoClient를 사용하고, 연결할 시드 목록을 제공
    - **시드**는 애플리케이션이 데이터를 읽고 쓸 복제 셋의 멤버
    - 시드 목록은 단순한 서버 주소 목록
      - 시드 목록에 복제 셋의 모든 멤버 나열할 필요 없음
      - 드라이버는 제공된 시드 멤버에 연결된 후 복제 셋의 모든 멤버를 자동으로 발견
- **복제 셋의 목적은 네트워크 파티션이나 서버가 다운될 때도 데이터의 가용성을 높이는 것**
  - 프라이머리가 다운되면 가능한 한 빨리 새로운 프라이머리를 찾고 요청을 라우팅
  - 하지만, 도달 가능한 프라이머리가 없는 경우 쓰기를 수행 불가능

#### 복제 셋 연결 설정
```javascript
const mongoose = require('mongoose');

// 복제 셋의 시드 목록 (프라이머리 및 세컨더리 포함)
const uri = 'mongodb://server-1:27017,server-2:27017,server-3:27017/mydatabase?replicaSet=myReplicaSet';

mongoose.connect(uri, {
  useNewUrlParser: true,
  useUnifiedTopology: true,
  readPreference: 'primary' // option
}).then(() => {
  console.log('MongoDB에 연결되었습니다.');
}).catch((err) => {
  console.error('MongoDB 연결 오류:', err);
});
```

- `readPreference` 옵션을 통해 클라이언트가 데이터를 읽을 때 사용할 서버를 결정 가능
  - `primary`
    - 기본값, 모든 읽기 작업이 프라이머리에서 수행
    - 강한 일관성이 필요한 경우, 최신 데이터 보장
  - `primaryPreferred`
    - 기본적으로 프라이머리에서 읽기를 수행하지만, 프라이머리가 사용 불가능하면 세컨더리에서 읽음
    - 프라이머리 장애 발생 시에도 읽기 연속성을 유지하고 싶은 경우
  - `secondary`
    - 모든 읽기 작업이 세컨더리에서 수행
    - 읽기 작업을 분산하여 프라이머리의 부하를 줄이고 싶은 경우, 데이터 일관성이 약할 수 있음
  - `secondaryPreferred`
    - 기본적으로 세컨더리에서 읽기를 수행하지만, 세컨더리가 사용 불가능하면 프라이머리에서 읽음
    - 읽기 부하 분산이 필요하지만, 세컨더리가 모두 불가능할 경우에도 읽기를 유지하고 싶은 경우
  - `nearest`
    - 지연 시간이 가장 짧은 멤버에서 읽기를 수행합니다(프라이머리 또는 세컨더리)
    - 응답 시간 최적화가 중요한 경우, 일관성이 약할 수 있음

##### 고려 사항
- 아래와 같은 특성과 요규 사항을 고려하여 적절한 `readPreference` 값을 선택해야함

- **일관성**
  - 프라이머리에서 읽기 수행하면 최신 데이터를 얻을 수 있지만, 세컨더리에서 읽기를 수행하면 지연 발생 가능
- **성능**
  - 읽기 부하를 세컨더리로 분산하면 프라이머리의 부하 줄일 수 있음
- **가용성**
  - 프라이머리가 장애가 발생할 경우, 세컨더리에서 읽기를 수행하면 가용성을 높일 수 있음

#### DNS Seedlist 연결 형식
- 추가적인 복원력을 제공하려면 DNS Seedlist 연결 형식을 사용해 복제 셋에 연결하는 방법을 지정
- SRV 레코드를 사용하여 복제 셋의 멤버를 동적으로 탐색
- 클라이언트는 DNS에서 SRV 레코드를 조회하여 복제 셋 멤버의 주소를 자동으로 가져옴
- **MongoDB 클러스터의 관리가 용이해지고, 복제 셋의 가용성과 복원력을 높일 수 있음**

```javascript
const mongoose = require('mongoose');

// DNS Seedlist 형식을 사용하여 복제 셋에 연결
const uri = 'mongodb+srv://<username>:<password>@<cluster-url>/mydatabase?retryWrites=true&w=majority';

mongoose.connect(uri, {
  useNewUrlParser: true,
  useUnifiedTopology: true,
  readPreference: 'secondaryPreferred'
}).then(() => {
  console.log('MongoDB에 연결되었습니다.');
}).catch((err) => {
  console.error('MongoDB 연결 오류:', err);
});
```

- **자동 서버 발견**
  - 클라이언트가 연결할 서버를 자동으로 검색하여 복제 셋의 변경 사항 반영
- **단순화된 설정**
  - 시드 목록을 수동으로 관리할 필요 없음
- **복원력 향상**
  - 복제 셋 멤버가 변경되더라도 클라이언트는 자동으로 새로운 멤버를 발견하여 연결 가능

| 특징 | `mongodb://` | `mongodb+srv://` |
|------|--------------|------------------|
|명시적 멤버 지정|Y|N|
|자동 서버 발견|N|Y|
|설정 복잡도|복제 셋 멤버를 명시적 나열|DNS에서 자동 탐색|
|복제 셋 멤버 변경 시 업데이트|수동으로 연결 문자열을 업데이트|자동으로 SRV 레코드를 통해 탐색|

#### 서버 검색 및 모니터링 (Server Discover and Monitoring: SDAM)
- 모든 MongoDB 드라이버는 SDAM 사양을 준수
- MongoDB 드라이버의 핵심 기능 중 하나로, **클라이언트가 MongoDB 서버와의 연결 상태를 지속적으로 모니터링하고 관리 가능**토록 함
- 이를 통해 애플리케이션은 서버의 상태 변화에 따라 적절히 대응 가능
- 특히 **복제 셋과 샤딩된 클러스터와 같은 복잡한 MongoDB 토폴로지에서 중요**

##### 동작 순서
1. **서버 검색 및 초기 연결**
    - 드라이버는 초기 연결 시 지정된 시드 목록을 사용하여 MongoDB 서버의 현재 토폴로지를 검색
2. **지속적인 모니터링 및 상태 확인**
    - 클라이언트는 연결된 서버의 상태를 주기적으로 확인(Heartbeat)
    - 주기적으로 서버의 상태를 확인하여, 새로운 멤버가 추가되거나 기존 멤버의 상태가 변경되는 것(서버 가용  여부) 등을 감지
3. **토폴로지 변경 감지 및 프라이머리 인식**
    - 복제 셋의 경우 프라이머리 전환(failover) 등의 이벤트를 감지하여 새로운 프라이머리를 식별
    - 샤딩된 클러스터의 경우, 샤드의 추가/제거 및 상태 변화를 감지
    - 복제 셋의 경우, 프라이머리가 변경되면 새로운 프라이머리를 식별하여 적절히 읽기 및 쓰기 작업을 라우팅
4. **장애 감지 및 대처**
    - 서버의 상태 변화(예: 프라이머리 장애, 네트워크 분할 등)에 대응하여 자동으로 다른 서버에 재연결하거나, 필요한 경우 애플리케이션에 오류를 전달
